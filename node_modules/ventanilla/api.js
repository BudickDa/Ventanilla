var request = require("request");

exports.initApi = function(block){
  console.log("Will create Api - initilizing");
  var pid = -1;
  for(i in block.pins){
    if(block.pins[i].direction === "output"){
      pid = block.pins[i].pid;
    }
  }
  if(pid===-1){
    console.log("Will create Api - error: Api-Block has no output pin. That's weird.")
  }
  else{
    apiInterfaces[block.hardware.key] = function(data){
      try{
        app.io.broadcast("pid"+pid,data);
        return 200;
      }catch(e){
        console.log("Error fireing Api-Output for pid "+pid+". Data is "+data);
      }
    };
    console.log("Will create Api - succesfull");
  }
  return sendData(block)
}

function sendData(block){
  /*send post data from send*/
  try{
    if(block.input!==undefined){
      for(i in block.input){
        if(blocks[block.input[i].uid]===undefined||blocks[block.input[i].uid].value===undefined){
          continue;
        }
        request.post(
          "http://"+block.hardware.ip + "/api",
          {"value":blocks[block.input[i].uid].value[block.input[i].pid],"key":block.hardware.key},
          function(error,response,body){
            if(error){console.log("Error sending Api-input for pid "+block.input[i].pid+". Error: "+error);}
            else if(response.statusCode === 200){console.log(body);}
          }
        );
      }
    }
  }catch(e){
    console.log("Error in sendData in ventanilla/sendData: " +e)
  }
  finally{
    try{
        setTimeout(function(){
          return sendData(block);
        },1000);
      }catch(e){
        console.log("Error at sendData in ventanilla/api.js: sendData has stopped working: " + e);
      }
  }
}

